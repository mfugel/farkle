<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farkle – FINAL & WINNING SCORE CUSTOMIZABLE</title>
    <style>
        :root {
            --dice-1: linear-gradient(135deg, #ff6b6b, #ee5a52);
            --dice-2: linear-gradient(135deg, #4834d4, #3742fa);
            --dice-3: linear-gradient(135deg, #00d2d3, #01a3a4);
            --dice-4: linear-gradient(135deg, #ff9ff3, #f368e0);
            --dice-5: linear-gradient(135deg, #54a0ff, #2e86de);
            --dice-6: linear-gradient(135deg, #5f27cd, #341f97);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(0,0,0,0.4);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 { text-align: center; margin-bottom: 10px; font-size: 2.8em; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .setup { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .setup h2 { margin-top: 0; text-align: center; }
        .setup-row { display: flex; justify-content: center; align-items: center; gap: 12px; margin: 15px 0; flex-wrap: wrap; }
        .setup-row label { font-weight: bold; }
        input[type="number"] {
            padding: 8px 12px; font-size: 1em; border-radius: 6px; border: none; width: 120px;
            background: rgba(255,255,255,0.2); color: white;
        }
        .player-list { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; justify-content: center; }
        .player-item { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.15); padding: 8px 12px; border-radius: 8px; min-width: 180px; }
        .player-item input { background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 8px; border-radius: 6px; width: 120px; }
        .player-item button { background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        button {
            background: #3498db; color: white; border: none; padding: 10px 16px; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: all 0.2s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .top-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .current-player { font-size: 1.5em; text-align: center; margin: 20px 0; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 12px; }
        .target-score { text-align: center; font-size: 1.3em; margin: 10px 0; opacity: 0.9; }
        .dice-container { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin: 30px 0; min-height: 100px; perspective: 600px; }
        .die {
            width: 70px; height: 70px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); position: relative; overflow: hidden;
            user-select: none; border: 4px solid transparent;
            transform-style: preserve-3d;
        }
        .die.rolling { animation: rollDice 0.8s cubic-bezier(0.2, 0.8, 0.4, 1); }
        @keyframes rollDice {
            0%   { transform: translateY(0) rotateX(0) rotateY(0); }
            100% { transform: translateY(-20px) rotateX(720deg) rotateY(720deg); }
        }
        .die:hover:not(.kept):not(.rolling) { transform: scale(1.08); }
        .die.scoring { border-color: #f1c40f !important; box-shadow: 0 0 30px rgba(241,196,15,1); }
        .die.kept { border-color: #2ecc71 !important; box-shadow: 0 0 30px rgba(46,204,113,1); opacity: 0.9; transform: scale(0.95); cursor: default; }
        .die svg { width: 100%; height: 100%; }
        .dot { fill: #fff; }
        .die.d1 { background: var(--dice-1); }
        .die.d2 { background: var(--dice-2); }
        .die.d3 { background: var(--dice-3); }
        .die.d4 { background: var(--dice-4); }
        .die.d5 { background: var(--dice-5); }
        .die.d6 { background: var(--dice-6); }
        .score-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 20px 0; }
        .player-score { background: rgba(255,255,255,0.15); padding: 12px; border-radius: 12px; text-align: center; }
        .player-score.current { border: 3px solid #f1c40f; transform: scale(1.05); }
        .player-score.winner { border: 3px solid #2ecc71; background: rgba(46,204,113,0.3); }
        .turn-info { text-align: center; margin: 15px 0; font-size: 1.1em; }
        .selected-score { font-size: 1.6em; color: #2ecc71; margin: 12px 0; font-weight: bold; }
        .roll-score { font-size: 1.3em; color: #f1c40f; margin: 8px 0; }
        .log { max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; font-size: 0.9em; margin-top: 15px; }
        .hot-dice { color: #f1c40f; font-weight: bold; animation: pulse 1.5s infinite; }
        .farkle { color: #e74c3c; font-weight: bold; font-size: 1.4em; animation: shake 0.5s; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }
        @keyframes shake { 0%,100% { transform:translateX(0); } 25% { transform:translateX(-5px); } 75% { transform:translateX(5px); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>FARKLE</h1>

        <div id="setup" class="setup">
            <h2>Game Setup</h2>
            <div class="setup-row">
                <label for="winScore">Winning Score:</label>
                <input type="number" id="winScore" value="10000" min="1000" step="1000">
            </div>
            <div class="setup-row">
                <button id="addPlayer">Add Player</button>
            </div>
            <div class="player-list" id="playerList">
                <div class="player-item">
                    <input type="text" value="Player 1">
                    <button class="remove-player">×</button>
                </div>
            </div>
            <div style="text-align:center;margin-top:20px;">
                <button id="startGame" style="background:#2ecc71;font-size:1.2em;padding:14px 32px;">Start Game</button>
            </div>
        </div>

        <div id="game" style="display:none;">
            <div class="top-controls">
                <button id="rollBtn">Roll Dice</button>
                <button id="bankBtn" disabled>Bank Score</button>
                <button id="newGameBtn" style="background:#95a5a6;">New Game</button>
            </div>
            <div class="current-player" id="currentPlayer"></div>
            <div class="target-score" id="targetScore">First to <strong>10,000</strong> points wins!</div>

            <div class="dice-container" id="diceContainer"></div>

            <div class="turn-info">
                <div class="selected-score" id="selectedScore">Selected Points: 0</div>
                <div class="roll-score" id="rollScore"></div>
                <div>Turn Total: <strong id="turnScore">0</strong></div>
                <div id="statusMessage"></div>
            </div>

            <div class="score-board" id="scoreBoard"></div>
            <div class="log" id="gameLog"></div>
        </div>
    </div>

    <script>
        let audioCtx = null;
        function playSound(type) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.start();
            if (type === 'roll') {
                o.frequency.setValueAtTime(800, audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);
                g.gain.setValueAtTime(0.15, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                o.stop(audioCtx.currentTime + 0.2);
            }
        }

        const state = {
            players: [], scores: [], currentPlayer: 0, turnScore: 0,
            dice: [], kept: new Set(), activeDice: 6, winScore: 10000,
            rolling: false, hotDice: false
        };

        const els = {
            setup: document.getElementById('setup'), game: document.getElementById('game'),
            winScore: document.getElementById('winScore'), targetScore: document.getElementById('targetScore'),
            addPlayer: document.getElementById('addPlayer'), startGame: document.getElementById('startGame'),
            playerList: document.getElementById('playerList'),
            rollBtn: document.getElementById('rollBtn'), bankBtn: document.getElementById('bankBtn'),
            newGameBtn: document.getElementById('newGameBtn'), diceContainer: document.getElementById('diceContainer'),
            currentPlayer: document.getElementById('currentPlayer'), turnScore: document.getElementById('turnScore'),
            selectedScore: document.getElementById('selectedScore'), rollScore: document.getElementById('rollScore'),
            statusMessage: document.getElementById('statusMessage'), scoreBoard: document.getElementById('scoreBoard'),
            gameLog: document.getElementById('gameLog')
        };

        document.addEventListener('DOMContentLoaded', () => {
            els.addPlayer.addEventListener('click', () => {
                if (els.playerList.children.length >= 6) return alert('Max 6 players');
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `<input type="text" value="Player ${els.playerList.children.length + 1}"><button class="remove-player">×</button>`;
                els.playerList.appendChild(div);
            });

            els.startGame.addEventListener('click', startGame);
            els.rollBtn.addEventListener('click', rollDice);
            els.bankBtn.addEventListener('click', bankScore);
            els.newGameBtn.addEventListener('click', () => confirm('Start a new game?') && location.reload());

            els.playerList.addEventListener('click', e => {
                if (e.target.classList.contains('remove-player')) e.target.parentElement.remove();
            });
        });

        function startGame() {
            const names = Array.from(els.playerList.querySelectorAll('input')).map(i => i.value.trim() || `Player ${i+1}`);
            if (!names.length) return alert('Add at least one player');
            state.players = names;
            state.scores = names.map(() => 0);
            state.winScore = Math.max(1000, parseInt(els.winScore.value) || 10000);
            els.targetScore.innerHTML = `First to <strong>${state.winScore.toLocaleString()}</strong> points wins!`;
            els.setup.style.display = 'none';
            els.game.style.display = 'block';
            nextTurn();
            log(`Game started! First to ${state.winScore.toLocaleString()} wins!`);
        }

        function nextTurn() {
            state.turnScore = 0;
            state.dice = [];
            state.kept.clear();
            state.activeDice = 6;
            state.hotDice = false;
            state.rolling = false;
            els.diceContainer.innerHTML = '';
            els.turnScore.textContent = '0';
            els.selectedScore.textContent = 'Selected Points: 0';
            els.rollScore.textContent = '';
            els.statusMessage.textContent = '';
            els.bankBtn.disabled = true;
            els.rollBtn.disabled = false;
            updateCurrentPlayer();
            updateScoreBoard();
            log(`${state.players[state.currentPlayer]}'s turn`);
        }

        function updateCurrentPlayer() {
            els.currentPlayer.textContent = `${state.players[state.currentPlayer]}'s Turn`;
        }

        function updateTurnScore() {
            const keptValues = Array.from(state.kept).map(i => state.dice[i]);
            state.turnScore = calculateScoreFromValues(keptValues);
            els.selectedScore.textContent = `Selected Points: ${state.turnScore.toLocaleString()}`;
            els.turnScore.textContent = state.turnScore.toLocaleString();
        }

        function calculateScoreFromValues(values) {
            if (!values.length) return 0;
            const count = {};
            values.forEach(v => count[v] = (count[v] || 0) + 1);
            let score = 0;

            if (values.length === 6) {
                if (new Set(values).size === 6) return 1500;
                if (Object.keys(count).length === 3 && Object.values(count).every(v => v === 2)) return 1500;
            }

            for (const n in count) {
                const num = +n;
                if (count[num] >= 3) {
                    const base = num === 1 ? 1000 : num * 100;
                    const groups = Math.floor(count[num] / 3);
                    score += base * groups;
                }
            }

            values.forEach(v => {
                if (v === 1 && (!count[1] || count[1] < 3)) score += 100;
                if (v === 5 && (!count[5] || count[5] < 3)) score += 50;
            });

            return score;
        }

        function rollDice() {
            if (state.rolling || state.activeDice === 0) return;
            state.rolling = true;
            els.rollBtn.disabled = true;
            playSound('roll');

            const newRoll = Array.from({length: state.activeDice}, () => Math.floor(Math.random() * 6) + 1);
            let rollIdx = 0;
            if (state.dice.length === 0) state.dice = newRoll;
            else {
                for (let i = 0; i < state.dice.length; i++) {
                    if (!state.kept.has(i)) state.dice[i] = newRoll[rollIdx++];
                }
            }

            renderAllDice(true);

            setTimeout(() => {
                const newlyRolledVals = [];
                const newlyRolledIdx = [];
                for (let i = 0; i < state.dice.length; i++) {
                    if (!state.kept.has(i)) {
                        newlyRolledVals.push(state.dice[i]);
                        newlyRolledIdx.push(i);
                    }
                }

                const { score, scoringIndices } = calculatePotentialScore(newlyRolledVals);

                if (score === 0) { farkle(); return; }

                els.rollScore.textContent = `This roll can score: +${score}`;
                els.bankBtn.disabled = state.turnScore === 0;

                scoringIndices.forEach(local => {
                    const global = newlyRolledIdx[local];
                    els.diceContainer.children[global].classList.add('scoring');
                });

                log(`Rolled: ${newRoll.join(', ')} → can score +${score}`);
                updateScoreBoard();

                state.rolling = false;
                els.rollBtn.disabled = false;

                if (state.activeDice === 0) setTimeout(hotDice, 600);
            }, 900);
        }

        function calculatePotentialScore(dice) {
            if (!dice.length) return {score:0, scoringIndices:[]};
            const count = {};
            dice.forEach(d => count[d] = (count[d] || 0) + 1);
            let score = 0;
            const scoring = [];

            if (dice.length === 6) {
                if (new Set(dice).size === 6) return {score:1500, scoringIndices:[0,1,2,3,4,5]};
                if (Object.keys(count).length === 3 && Object.values(count).every(v=>v===2))
                    return {score:1500, scoringIndices:[0,1,2,3,4,5]};
            }

            for (const n in count) {
                const num = +n;
                if (count[num] >= 3) {
                    const base = num === 1 ? 1000 : num * 100;
                    const groups = Math.floor(count[num] / 3);
                    score += base * groups;
                    let marked = 0;
                    for (let i = 0; i < dice.length && marked < groups*3; i++) {
                        if (dice[i] === num) { scoring.push(i); marked++; }
                    }
                }
            }

            [1,5].forEach(n => {
                dice.forEach((d,i) => {
                    if (d===n && !scoring.includes(i)) {
                        scoring.push(i);
                        score += n===1 ? 100 : 50;
                    }
                });
            });

            return {score, scoringIndices: scoring};
        }

        function renderAllDice(animate = false) {
            els.diceContainer.innerHTML = '';
            state.dice.forEach((val, i) => {
                const die = document.createElement('div');
                die.className = `die d${val}${animate && !state.kept.has(i) ? ' rolling' : ''}`;
                die.dataset.index = i;

                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', '0 0 100 100');
                const dots = {1:[[50,50]],2:[[25,25],[75,75]],3:[[25,25],[50,50],[75,75]],
                              4:[[25,25],[25,75],[75,25],[75,75]],5:[[25,25],[25,75],[50,50],[75,25],[75,75]],
                              6:[[25,25],[25,50],[25,75],[75,25],[75,50],[75,75]]};
                dots[val].forEach(([x,y]) => {
                    const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    c.setAttribute('cx', x); c.setAttribute('cy', y); c.setAttribute('r', 8);
                    c.className = 'dot';
                    svg.appendChild(c);
                });
                die.appendChild(svg);

                die.addEventListener('click', () => {
                    if (state.rolling) return;
                    const isKept = state.kept.has(i);
                    const isScoring = die.classList.contains('scoring');

                    if (isKept) {
                        state.kept.delete(i);
                        state.activeDice++;
                        die.classList.remove('kept');
                        if (isScoring) die.classList.add('scoring');
                        log(`Un-kept a ${val}`);
                    } else if (isScoring || state.kept.size > 0) {
                        state.kept.add(i);
                        state.activeDice--;
                        die.classList.remove('scoring');
                        die.classList.add('kept');
                        log(`Kept a ${val}`);
                    }

                    updateTurnScore();
                    els.bankBtn.disabled = state.turnScore === 0;

                    if (state.activeDice === 0 && !state.hotDice) setTimeout(hotDice, 400);
                });

                if (state.kept.has(i)) die.classList.add('kept');
                els.diceContainer.appendChild(die);
            });
            updateTurnScore();
        }

        function hotDice() {
            state.hotDice = true;
            state.activeDice = 6;
            state.kept.clear();
            state.dice = [];
            els.diceContainer.innerHTML = '';
            els.statusMessage.textContent = 'HOT DICE! Rolling all 6!';
            els.statusMessage.className = 'hot-dice';
            log('HOT DICE! Rolling all 6 again!');
            setTimeout(() => { state.hotDice = false; rollDice(); }, 1200);
        }

        function bankScore() {
            if (state.turnScore === 0) return;
            state.scores[state.currentPlayer] += state.turnScore;
            log(`${state.players[state.currentPlayer]} banks ${state.turnScore.toLocaleString()} points!`);
            updateScoreBoard();
            if (state.scores[state.currentPlayer] >= state.winScore) {
                endGame();
                return;
            }
            state.currentPlayer = (state.currentPlayer + 1) % state.players.length;
            setTimeout(nextTurn, 800);
        }

        function farkle() {
            els.statusMessage.textContent = 'FARKLE!';
            els.statusMessage.className = 'farkle';
            log(`${state.players[state.currentPlayer]} farkled! Turn score lost.`);
            setTimeout(() => {
                state.currentPlayer = (state.currentPlayer + 1) % state.players.length;
                nextTurn();
            }, 2000);
        }

        function updateScoreBoard() {
            els.scoreBoard.innerHTML = '';
            state.players.forEach((name, i) => {
                const div = document.createElement('div');
                div.className = 'player-score';
                if (i === state.currentPlayer) div.classList.add('current');
                if (state.scores[i] >= state.winScore) div.classList.add('winner');
                div.innerHTML = `<div style="font-weight:bold">${name}</div>
                                 <div style="font-size:1.4em">${state.scores[i].toLocaleString()}</div>
                                 ${i === state.currentPlayer && state.turnScore > 0 ? `<div style="color:#2ecc71">+${state.turnScore.toLocaleString()}</div>` : ''}`;
                els.scoreBoard.appendChild(div);
            });
        }

        function endGame() {
            els.rollBtn.disabled = true;
            els.bankBtn.disabled = true;
            els.statusMessage.textContent = `${state.players[state.currentPlayer]} WINS!`;
            els.statusMessage.style.color = '#2ecc71';
            els.statusMessage.style.fontSize = '2em';
            log(`WINNER: ${state.players[state.currentPlayer]}!`);
        }

        function log(msg) {
            const d = document.createElement('div');
            d.textContent = `> ${msg}`;
            els.gameLog.appendChild(d);
            els.gameLog.scrollTop = els.gameLog.scrollHeight;
        }
    </script>
</body>
</html>
